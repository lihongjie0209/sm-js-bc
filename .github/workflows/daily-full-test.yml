name: Daily Full Test Suite

on:
  # 每天凌晨 2:00 (UTC) 运行
  schedule:
    - cron: '0 2 * * *'
  
  # 允许手动触发
  workflow_dispatch:
  
  # 也在 main 分支推送时运行（可选）
  push:
    branches:
      - main
      - master

jobs:
  javascript-tests:
    name: JavaScript Tests (Node.js ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Run JavaScript unit tests
        run: npm test
      
      - name: Run test coverage
        run: npm run test:coverage
        continue-on-error: true
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: matrix.node-version == '20.x'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: javascript
          name: javascript-coverage
        continue-on-error: true

  java-integration-tests:
    name: Java Integration Tests (JDK ${{ matrix.java-version }})
    runs-on: ubuntu-latest
    needs: javascript-tests
    
    strategy:
      matrix:
        java-version: [17, 21]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Setup Java ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      
      - name: Install Node.js dependencies
        run: npm ci
      
      - name: Build JavaScript library
        run: npm run build
      
      - name: Run Java integration tests
        run: |
          cd test/graalvm-integration/java
          mvn clean test -B
        env:
          MAVEN_OPTS: -Xmx1024m
      
      - name: Upload Java test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: java-test-results-jdk${{ matrix.java-version }}
          path: test/graalvm-integration/java/target/surefire-reports/
          retention-days: 7

  full-test-suite:
    name: Full Test Suite (All Tests)
    runs-on: ubuntu-latest
    needs: javascript-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Setup Java (GraalVM)
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: 'maven'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Run all tests (JavaScript + Java)
        run: npm run test:all
        timeout-minutes: 30
      
      - name: Upload combined test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-test-results
          path: |
            coverage/
            test/graalvm-integration/java/target/surefire-reports/
          retention-days: 7

  notify-results:
    name: Notify Test Results
    runs-on: ubuntu-latest
    needs: [javascript-tests, java-integration-tests, full-test-suite]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "JavaScript Tests: ${{ needs.javascript-tests.result }}"
          echo "Java Integration Tests: ${{ needs.java-integration-tests.result }}"
          echo "Full Test Suite: ${{ needs.full-test-suite.result }}"
          
          if [ "${{ needs.javascript-tests.result }}" != "success" ] || \
             [ "${{ needs.java-integration-tests.result }}" != "success" ] || \
             [ "${{ needs.full-test-suite.result }}" != "success" ]; then
            echo "❌ Some tests failed!"
            exit 1
          else
            echo "✅ All tests passed!"
          fi
